{showHistory && (
            <div className="bg-white/5 rounded-2xl p-5 border border-white/10 backdrop-blur-sm">
              <h3 className="text-xl font-bold text-white mb-4 flex items-center justify-between">
                <span>Recent Transactions</span>
                <span className="text-sm font-normal text-white/60">({transactions.length} total)</span>
              </h3>
              {transactions.length > 0 ? (
                <div className="space-y-2 max-h-60 overflow-y-auto">
                  {transactions.map((txData, idx) => {
                    try {
                      // XRPL returns transaction data in a specific structure
                      // The actual transaction is in txData.tx
                      const tx = txData.tx;
                      const meta = txData.meta;
                      
                      if (!tx || !tx.TransactionType) {
                        console.warn('Invalid transaction at index', idx, txData);
                        return null;
                      }

                      console.log('Processing transaction:', tx);

                      // Determine transaction details
                      const isSent = tx.Account === wallet.address;
                      const isReceived = tx.Destination === wallet.address && tx.TransactionType === 'Payment';
                      
                      // Handle amount - can be string (drops) or object (for non-XRP currencies)
                      let amount = '0.00';
                      if (tx.Amount) {
                        if (typeof tx.Amount === 'string') {
                          // XRP amount in drops
                          amount = (parseInt(tx.Amount) / 1000000).toFixed(2);
                        } else if (typeof tx.Amount === 'object' && tx.Amount.value) {
                          // Non-XRP currency
                          amount = parseFloat(tx.Amount.value).toFixed(2);
                        }
                      }
                      
                      const txType = tx.TransactionType;
                      const txHash = tx.hash || txData.hash || 'Unknown';
                      
                      // Convert XRPL timestamp (seconds since 2000-01-01) to JavaScript Date
                      let txDate = 'Unknown date';
                      if (tx.date) {
                        const unixTimestamp = (tx.date + 946684800) * 1000;
                        txDate = new Date(unixTimestamp).toLocaleString();
                      }
                      
                      // Check if transaction was successful
                      const isSuccess = meta && (meta.TransactionResult === 'tesSUCCESS');
                      
                      return (
                        <div key={`${txHash}-${idx}`} className="bg-black/20 rounded-xl p-3 border border-white/10">
                          <div className="flex justify-between items-start">
                            <div className="flex-1 min-w-0 mr-3">
                              <div className="flex items-center gap-2 mb-1 flex-wrap">
                                <span className={`text-xs font-bold px-2 py-1 rounded ${
                                  isSent ? 'bg-red-500/20 text-red-300' : 
                                  isReceived ? 'bg-green-500/20 text-green-300' : 
                                  'bg-blue-500/20 text-blue-300'
                                }`}>
                                  {isSent ? 'SENT' : isReceived ? 'RECEIVED' : txType}
                                </span>
                                {!isSuccess && (
                                  <span className="text-xs font-bold px-2 py-1 rounded bg-red-500/20 text-red-300">
                                    FAILED
                                  </span>
                                )}
                                <span className="text-xs text-white/40">
                                  {txDate}
                                </span>
                              </div>
                              <div className="text-xs font-mono text-white/60 break-all">
                                {txHash.length > 20 ? `${txHash.substring(0, 16)}...` : txHash}
                              </div>
                              {tx.DestinationTag && (
                                <div className="text-xs text-white/50 mt-1">
                                  Tag: {tx.DestinationTag}
                                </div>
                              )}
                            </div>
                            {txType === 'Payment' && tx.Amount && (
                              <div className={`text-right flex-shrink-0 font-bold ${
                                isSent ? 'text-red-400' : 'text-green-400'
                              }`}>
                                <div className="text-lg whitespace-nowrap">
                                  {isSent ? '-' : '+'}{amount} XRP
                                </div>
                                {xrpPrice && (
                                  <div className="text-xs text-white/50 whitespace-nowrap">
                                    ${(parseFloat(amount) * xrpPrice).toFixed(2)}
                                  </div>
                                )}
                              </div>
                            )}
                            {(txType !== 'Payment' || !tx.Amount) && (
                              <div className="text-right flex-shrink-0 font-bold text-white/50">
                                <div className="text-sm">{txType}</div>
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    } catch (error) {
                      console.error('Error rendering transaction at index', idx, error, txData);
                      return null;
                    }
                  }).filter(Boolean)}
                </div>
              ) : (
                <div className="text-center py-8">
                  <History className="w-12 h-12 text-white/20 mx-auto mb-3" />
                  <p className="text-white/60">No transactions yet</p>
                  <p className="text-white/40 text-sm mt-1">Send or receive XRP to see your transaction history</p>
                </div>
              )}
            </div>
          )}
