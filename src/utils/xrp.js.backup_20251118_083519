const SERVER_URL = 'wss://s.altnet.rippletest.net:51233';

export const getBalance = async (address) => {
  try {
    const xrpl = await import('xrpl');
    const client = new xrpl.Client(SERVER_URL);
    await client.connect();
    
    const response = await client.request({
      command: "account_info",
      account: address,
      ledger_index: "validated"
    });
    
    await client.disconnect();
    
    // Balance is in drops, convert to XRP (1,000,000 drops per XRP)
    const drops = response.result.account_data.Balance;
    return parseFloat(drops) / 1000000;
  } catch (error) {
    console.error("Error fetching balance:", error);
    
    // Account not found means it has 0 balance (not funded yet)
    if (error.message && error.message.includes('actNotFound')) {
      return 0;
    }
    
    throw error;
  }
};

export const sendXRP = async (secret, recipient, amount, destinationTag = null) => {
  try {
    const xrpl = await import('xrpl');
    const client = new xrpl.Client(SERVER_URL);
    await client.connect();

    const wallet = xrpl.Wallet.fromSeed(secret);
    
    // Amount must be in drops (1 XRP = 1,000,000 drops)
    const amountDrops = (amount * 1000000).toString();

    const transaction = {
      TransactionType: "Payment",
      Account: wallet.address,
      Amount: amountDrops,
      Destination: recipient,
      ...(destinationTag && { DestinationTag: destinationTag }),
    };

    const prepared = await client.autofill(transaction);
    const signed = wallet.sign(prepared);
    
    const result = await client.submitAndWait(signed.tx_blob);

    await client.disconnect();
    return result;
  } catch (error) {
    console.error("Transaction Error Details:", error);
    throw error;
  }
};

export const isValidAddress = (address) => {
  if (!address || typeof address !== 'string') return false;
  
  // Basic validation: XRP addresses start with 'r' and are 25-35 characters
  if (!address.startsWith('r') || address.length < 25 || address.length > 35) {
    return false;
  }
  
  // Check for valid base58 characters (no 0, O, I, l)
  const base58Regex = /^[1-9A-HJ-NP-Za-km-z]+$/;
  return base58Regex.test(address);
};

export const getTransactionHistory = async (address, limit = 10) => {
  try {
    const xrpl = await import('xrpl');
    const client = new xrpl.Client(SERVER_URL);
    await client.connect();

    const response = await client.request({
      command: "account_tx",
      account: address,
      limit: limit
    });

    await client.disconnect();
    return response.result.transactions || [];
  } catch (error) {
    console.error("Error fetching transaction history:", error);
    return [];
  }
};
