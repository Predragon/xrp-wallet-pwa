import React, { useState, useEffect } from 'react';
import {
Wallet, Send, Eye, EyeOff, Copy, RefreshCw, AlertCircle, CheckCircle,
History, QrCode, Lock, Unlock, BookOpen, Download, Trash2, ChevronDown, ChevronUp
} from 'lucide-react';

// Import the real XRPL functions
import {
generateWallet,
importWallet as importWalletFromSeed,
getBalance,
sendXRP,
isValidAddress,
getTransactionHistory,
getXRPPrice,
setNetwork,
getCurrentNetwork,
NETWORKS,
saveWallet,
loadWallet,
walletExists,
deleteWallet as deleteStoredWallet,
saveContact,
getContacts,
deleteContact,
saveSettings,
loadSettings,
// Add these imports for multiple wallet support
saveWalletToList,
getSavedWallets,
loadWalletFromList,
removeWalletFromList,
clearAllWallets,
} from './utils/xrp';

// Modal Components

// Wallet Selector Modal (New Component)
const WalletSelectorModal = ({ show, onClose, wallets, onSwitch, onDelete }) => {
  if (!show) return null;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 max-w-md w-full border border-white/20">
        <h3 className="text-2xl font-bold text-white mb-6">Switch Wallet</h3>

        {wallets.length === 0 ? (
          <p className="text-white/70 text-center py-4">No saved wallets found.</p>
        ) : (
          <div className="space-y-4 max-h-80 overflow-y-auto pr-2">
            {wallets.map((walletData) => (
              <div key={walletData.id} className="bg-white/10 rounded-xl p-3 flex items-center justify-between">
                <div className="flex-1 min-w-0 mr-4">
                  <p className="text-white font-semibold text-lg truncate">{walletData.name}</p>
                  <p className="text-white/60 text-xs font-mono truncate">{walletData.address}</p>
                </div>
                <div className="flex gap-2 items-center flex-shrink-0">
                  <button
                    onClick={() => {
                      const pwd = prompt('Enter password for this wallet:');
                      if (pwd) onSwitch(walletData, pwd);
                    }}
                    className="p-2 bg-blue-500/30 hover:bg-blue-500/50 rounded-lg text-blue-300 transition-all text-sm font-semibold"
                  >
                    Switch
                  </button>
                  <button
                    onClick={() => onDelete(walletData.id)}
                    className="p-2 bg-red-500/30 hover:bg-red-500/50 rounded-lg text-red-300 transition-all"
                    title="Delete Wallet"
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
        
        <button onClick={onClose} className="w-full mt-6 bg-white/10 hover:bg-white/20 text-white py-3 rounded-xl transition-all">
          Close
        </button>
      </div>
    </div>
  );
};

const TransactionModal = ({ show, onClose, onConfirm, recipient, amount, destinationTag, loading, error, success }) => {
if (!show) return null;

return (
<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
<div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 max-w-md w-full border border-white/20">
<h3 className="text-2xl font-bold text-white mb-4">Confirm Transaction</h3>

{!success && !error && (  
      <>  
        <div className="space-y-3 mb-6">  
          <div className="bg-white/10 rounded-xl p-3">  
            <p className="text-white/60 text-sm">To</p>  
            <p className="text-white font-mono text-sm break-all">{recipient}</p>  
          </div>  
          <div className="bg-white/10 rounded-xl p-3">  
            <p className="text-white/60 text-sm">Amount</p>  
            <p className="text-white font-bold text-xl">{amount} XRP</p>  
          </div>  
          {destinationTag && (  
            <div className="bg-white/10 rounded-xl p-3">  
              <p className="text-white/60 text-sm">Destination Tag</p>  
              <p className="text-white font-mono">{destinationTag}</p>  
            </div>  
          )}  
        </div>  
          
        <div className="flex gap-3">  
          <button  
            onClick={onClose}  
            disabled={loading}  
            className="flex-1 bg-white/10 hover:bg-white/20 text-white py-3 rounded-xl transition-all"  
          >  
            Cancel  
          </button>  
          <button  
            onClick={onConfirm}  
            disabled={loading}  
            className="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white py-3 rounded-xl transition-all flex items-center justify-center"  
          >  
            {loading ? <RefreshCw className="w-5 h-5 animate-spin" /> : 'Confirm'}  
          </button>  
        </div>  
      </>  
    )}  
      
    {error && (  
      <div className="mb-4">  
        <div className="bg-red-500/20 border border-red-400/50 rounded-xl p-4 flex items-start">  
          <AlertCircle className="w-5 h-5 text-red-400 mr-3 mt-0.5 flex-shrink-0" />  
          <div className="text-red-200 text-sm">{error}</div>  
        </div>  
        <button onClick={onClose} className="w-full mt-4 bg-white/10 hover:bg-white/20 text-white py-3 rounded-xl">  
          Close  
        </button>  
      </div>  
    )}  
      
    {success && (  
      <div className="mb-4">  
        <div className="bg-green-500/20 border border-green-400/50 rounded-xl p-4 flex items-start">  
          <CheckCircle className="w-5 h-5 text-green-400 mr-3 mt-0.5 flex-shrink-0" />  
          <div className="text-green-200 text-sm">  
            <p className="font-bold mb-1">Transaction Successful!</p>  
            <p className="font-mono text-xs break-all">{success.hash}</p>  
          </div>  
        </div>  
        <button onClick={onClose} className="w-full mt-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white py-3 rounded-xl">  
          Done  
        </button>  
      </div>  
    )}  
  </div>  
</div>

);
};

const QRCodeModal = ({ show, onClose, address }) => {
if (!show) return null;

return (
<div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
<div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-6 max-w-md w-full border border-white/20">
<h3 className="text-2xl font-bold text-white mb-4">Receive XRP</h3>
<div className="bg-white p-4 rounded-xl mb-4">
<div className="text-center text-gray-800 font-mono text-sm break-all">{address}</div>
</div>
<p className="text-white/70 text-sm mb-4 text-center">
Share this address to receive XRP
</p>
<button onClick={onClose} className="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 rounded-xl">
Close
</button>
</div>
</div>
);
};

const App = () => {
const [wallet, setWallet] = useState(null);
const [showSecret, setShowSecret] = useState(false);
const [balance, setBalance] = useState(null);
const [loading, setLoading] = useState(false);
const [recipient, setRecipient] = useState('');
const [amount, setAmount] = useState('');
const [destinationTag, setDestinationTag] = useState('');
const [copied, setCopied] = useState('');
const [showModal, setShowModal] = useState(false);
const [showQRModal, setShowQRModal] = useState(false);
const [txLoading, setTxLoading] = useState(false);
const [txError, setTxError] = useState(null);
const [txSuccess, setTxSuccess] = useState(null);
const [transactions, setTransactions] = useState([]);
const [showHistory, setShowHistory] = useState(false);
const [isAddressValid, setIsAddressValid] = useState(null);
const [xrpPrice, setXrpPrice] = useState(null);
const [isLocked, setIsLocked] = useState(true);
const [password, setPassword] = useState('');
const [hasStoredWallet, setHasStoredWallet] = useState(false);
const [network, setNetworkState] = useState('testnet');
const [contacts, setContacts] = useState([]);
const [showContacts, setShowContacts] = useState(false);
// Add these state variables with your other useState declarations
const [savedWallets, setSavedWallets] = useState([]);
const [showWalletSelector, setShowWalletSelector] = useState(false);
const [showInitialActions, setShowInitialActions] = useState(true);

useEffect(() => {
setHasStoredWallet(walletExists());
loadPriceData();
const settings = loadSettings();
setNetworkState(settings.network);
setNetwork(settings.network === 'mainnet' ? NETWORKS.MAINNET : NETWORKS.TESTNET);
setContacts(getContacts());
// Add this to your useEffect that loads initial data
setSavedWallets(getSavedWallets());

const priceInterval = setInterval(loadPriceData, 60000);  
return () => clearInterval(priceInterval);

}, []);

useEffect(() => {
if (recipient && recipient.length > 0) {
const valid = isValidAddress(recipient);
setIsAddressValid(valid);
} else {
setIsAddressValid(null);
}
}, [recipient]);

useEffect(() => {
if (wallet && wallet.address && !isLocked) {
checkBalance();
loadTransactionHistory();
}
}, [wallet, isLocked, network]);

const loadPriceData = async () => {
const price = await getXRPPrice();
setXrpPrice(price);
};

// Add these new functions
const switchToWallet = (walletData, pwd) => {
  const decryptedWallet = loadWalletFromList(walletData.id, pwd);
  if (decryptedWallet) {
    setWallet(decryptedWallet);
    setIsLocked(false);
    setShowWalletSelector(false);
    setPassword('');
    // Clear the legacy single wallet storage if it exists after switching to multi-wallet
    deleteStoredWallet(); 
    setHasStoredWallet(false); // Only tracks legacy single wallet now
    setShowInitialActions(false); // Hide the wallet management section after switching
  } else {
    alert('Incorrect password');
  }
};

const deleteWalletFromList = (walletId) => {
  if (window.confirm('Delete this wallet? Make sure you have backed up the secret key!')) {
    if (removeWalletFromList(walletId)) {
      setSavedWallets(getSavedWallets());
      // If the currently active wallet is deleted, clear state
      if (wallet && wallet.id === walletId) {
        setWallet(null);
        setBalance(null);
        setTransactions([]);
        setIsLocked(false); // Go to the initial state screen
        setShowInitialActions(true);
      }
      if (getSavedWallets().length === 0) {
        setHasStoredWallet(false); // Revert to initial state logic if no wallets remain
      }
    }
  }
};

const unlockWallet = async () => {
if (!password) {
alert('Please enter your password');
return;
}

// Check if there are saved wallets in the new format
if (savedWallets.length > 0) {
  // If there are multiple wallets, we can't assume which one to unlock.
  // We'll prompt to select from the list.
  setShowWalletSelector(true);
  setIsLocked(false); // Show the selector interface
  setPassword('');
  return;
}

// Fallback to the legacy single-wallet unlock logic
const storedWallet = loadWallet(password);  
if (storedWallet) {  
  setWallet(storedWallet);  
  setIsLocked(false);  
  setPassword('');  
  setShowInitialActions(false);
} else {  
  alert('Incorrect password');
}

};

const lockWallet = () => {
setIsLocked(true);
setShowSecret(false);
setPassword('');
setShowInitialActions(true); // Always show initial actions when locking/logging out
};

// Update your saveWalletSecurely function
const saveWalletSecurely = () => {
  if (!wallet) return alert('No wallet to save.');

  const walletName = prompt('Enter a name for this wallet (e.g., "Main Wallet", "Trading"):');
  if (!walletName || walletName.trim() === '') return;

  const pwd = prompt('Set a password to encrypt your wallet (min 6 characters):');
  if (pwd && pwd.length >= 6) {
    // New logic: save to list
    if (saveWalletToList(wallet, pwd, walletName.trim())) {
      alert('‚úÖ Wallet saved securely!');
      setHasStoredWallet(true); // Now indicates at least one wallet is stored (old or new list)
      setSavedWallets(getSavedWallets());
      // If the legacy single wallet exists, delete it to prevent confusion
      deleteStoredWallet();
      setShowInitialActions(false); // Hide creation actions after successful save
    } else {
      alert('‚ùå Failed to save wallet (may already exist)');
    }
  } else {
    alert('Password must be at least 6 characters');
  }
};

const switchNetwork = async (newNetwork) => {
if (newNetwork === 'mainnet') {
const confirm = window.confirm(
'‚ö†Ô∏è WARNING: You are switching to MAINNET. This uses REAL XRP!\n\nAre you absolutely sure you want to continue?'
);
if (!confirm) return;
}

setNetworkState(newNetwork);  
await setNetwork(newNetwork === 'mainnet' ? NETWORKS.MAINNET : NETWORKS.TESTNET);  
saveSettings({ ...loadSettings(), network: newNetwork });  
  
if (wallet) {  
  checkBalance();  
  loadTransactionHistory();  
}

};

const generateNewWallet = async () => {
try {
setLoading(true);

const newWallet = generateWallet();  
    
  setWallet(newWallet);  
  setBalance(0);  
  setIsLocked(false);  
  setShowInitialActions(false);
    
  setTimeout(() => {  
    const fundingUrl = network === 'mainnet'   
      ? 'an exchange like Coinbase/Binance'   
      : 'https://xrpl.org/xrp-testnet-faucet.html';  
      
    alert(  
      `‚úÖ Wallet Generated!\n\nüìã Address: ${newWallet.address}\n\n${network === 'mainnet' ? '‚ö†Ô∏è MAINNET - Uses REAL XRP!\n\n' : ''}üí∞ To fund this wallet:\nVisit: ${fundingUrl}\n\nüîê IMPORTANT: Save your wallet using the "Save Wallet" button!`  
    );  
  }, 500);  
    
} catch (error) {  
  console.error('Error generating wallet:', error);  
  alert(`Error: ${error.message}`);  
} finally {  
  setLoading(false);  
}

};

const importWallet = async () => {
const secret = prompt('Enter your XRP secret key (starts with "s"):');
if (secret && secret.trim()) {
try {
setLoading(true);
const trimmedSecret = secret.trim();
const importedWallet = importWalletFromSeed(trimmedSecret);

setWallet(importedWallet);  
    setIsLocked(false);  
    setShowInitialActions(false);
      
    setTimeout(() => {  
      checkBalance();  
      loadTransactionHistory();  
    }, 500);  
  } catch (error) {  
    console.error('Import error:', error);  
    alert('Invalid secret key: ' + error.message);  
  } finally {  
    setLoading(false);  
  }  
}

};

const checkBalance = async () => {
if (!wallet || !wallet.address) return;

try {  
  setLoading(true);  
  const newBalance = await getBalance(wallet.address);  
  setBalance(newBalance);  
} catch (error) {  
  console.error('Error checking balance:', error);  
  setBalance(0);  
} finally {  
  setLoading(false);  
}

};

const loadTransactionHistory = async () => {
if (!wallet || !wallet.address) return;

try {  
  const txHistory = await getTransactionHistory(wallet.address, 20);  
  setTransactions(txHistory);  
} catch (error) {  
  console.error('Error loading transaction history:', error);  
  setTransactions([]);  
}

};

const handleSendClick = () => {
setTxError(null);
setTxSuccess(null);

if (!wallet || !wallet.secret) {  
  alert('Wallet not initialized');  
  return;  
}  

if (!recipient || recipient.trim() === '') {  
  alert('Please enter a recipient address');  
  return;  
}  
  
if (!isValidAddress(recipient.trim())) {  
  alert('Invalid XRP address');  
  return;  
}  
  
if (!amount || parseFloat(amount) <= 0) {  
  alert('Please enter a valid amount');  
  return;  
}  
  
if (parseFloat(amount) > balance) {  
  alert(`Insufficient balance. Available: ${balance} XRP`);  
  return;  
}  

if (network === 'mainnet') {  
  const confirm = window.confirm(  
    `‚ö†Ô∏è MAINNET TRANSACTION - REAL MONEY!\n\nYou are about to send ${amount} XRP to:\n${recipient}\n\nThis action is IRREVERSIBLE!\n\nAre you absolutely sure?`  
  );  
  if (!confirm) return;  
}  

setShowModal(true);

};

const handleConfirmTransaction = async () => {
setTxLoading(true);
setTxError(null);

try {  
  const result = await sendXRP(  
    wallet.secret,  
    recipient.trim(),  
    parseFloat(amount),  
    destinationTag && destinationTag !== '' ? parseInt(destinationTag) : null  
  );  
    
  setTxSuccess(result);  
    
  setTimeout(() => {  
    checkBalance();  
    loadTransactionHistory();  
  }, 3000);  
    
  setRecipient('');  
  setAmount('');  
  setDestinationTag('');  
} catch (error) {  
  console.error('Transaction failed:', error);  
  setTxError(error.message || 'Transaction failed');
} finally {  
  setTxLoading(false);  
}

};

const handleCloseModal = () => {
if (!txLoading) {
setShowModal(false);
setTimeout(() => {
setTxError(null);
setTxSuccess(null);
}, 300);
}
};

const copyToClipboard = (text, type) => {
if (text) {
navigator.clipboard.writeText(text).then(() => {
setCopied(type);
setTimeout(() => setCopied(''), 2000);
});
}
};

const addContact = () => {
const name = prompt('Contact name:');
if (!name) return;

const address = prompt('XRP address:');  
if (!address || !isValidAddress(address)) {  
  alert('Invalid address');  
  return;  
}  
  
const tag = prompt('Destination tag (optional):');  
  
const contact = saveContact(name, address, tag);  
if (contact) {  
  setContacts([...contacts, contact]);  
  alert('‚úÖ Contact saved!');  
}

};

const selectContact = (contact) => {
setRecipient(contact.address);
if (contact.tag) setDestinationTag(contact.tag);
setShowContacts(false);
};

const removeContact = (id) => {
if (window.confirm('Delete this contact?')) {
deleteContact(id);
setContacts(contacts.filter(c => c.id !== id));
}
};

// Check if any wallets are stored (either in the old single format or the new list format)
const isAnyWalletStored = hasStoredWallet || savedWallets.length > 0;

if (isAnyWalletStored && isLocked) {
return (
<div className="min-h-screen bg-gradient-to-br from-indigo-950 via-purple-900 to-pink-900 p-4 flex items-center justify-center">
<div className="bg-white/10 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-white/30 max-w-md w-full">
<div className="text-center mb-8">
<div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-blue-400 to-purple-600 rounded-2xl mb-4">
<Lock className="w-10 h-10 text-white" />
</div>
<h1 className="text-4xl font-bold text-white mb-2">Wallet Locked</h1>
<p className="text-white/70 text-sm">Enter your password to unlock</p>
</div>

<div className="space-y-4">  
        <input  
          type="password"  
          value={password}  
          onChange={(e) => setPassword(e.target.value)}  
          onKeyPress={(e) => e.key === 'Enter' && unlockWallet()}  
          placeholder="Enter password"  
          className="w-full bg-white/10 text-white px-4 py-3 rounded-xl border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-400 placeholder-white/50"  
        />  
          
        <button  
          onClick={unlockWallet}  
          className="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-bold py-3 rounded-xl transition-all"  
        >  
          <Unlock className="w-5 h-5 inline mr-2" />  
          Unlock Wallet  
        </button>  

        {/* This button handles both legacy single-wallet delete and clearing all new-style wallets */}
        <button  
          onClick={() => {  
            if (window.confirm('‚ö†Ô∏è WARNING: Deleting ALL locally stored wallet data! Make sure you have your secret keys backed up!')) {  
              deleteStoredWallet(); // Delete legacy single wallet
              clearAllWallets(); // Delete all new-style wallets
              setHasStoredWallet(false);  
              setSavedWallets([]);
              setIsLocked(false);  // Go to the initial state screen
            }  
          }}  
          className="w-full bg-red-500/20 hover:bg-red-500/30 text-red-300 font-semibold py-3 rounded-xl transition-all"  
        >  
          Delete All Stored Wallets  
        </button>  
      </div>  
    </div>  
    <WalletSelectorModal 
      show={showWalletSelector} 
      onClose={() => setShowWalletSelector(false)} 
      wallets={savedWallets} 
      onSwitch={switchToWallet} 
      onDelete={deleteWalletFromList} 
    />
  </div>  
);
}

return (
<div className="min-h-screen bg-gradient-to-br from-indigo-950 via-purple-900 to-pink-900 p-4 relative overflow-hidden">
<div className="absolute inset-0 overflow-hidden pointer-events-none">
<div className="absolute top-1/4 left-1/4 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl animate-pulse"></div>
<div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl animate-pulse"></div>
</div>

<div className="max-w-3xl mx-auto relative z-10">  
    <div className="flex justify-between items-center mb-4">  
      <div className="flex gap-2">  
        <button  
          onClick={() => switchNetwork('testnet')}  
          className={`px-4 py-2 rounded-xl font-semibold transition-all ${  
            network === 'testnet'   
              ? 'bg-green-500 text-white'   
              : 'bg-white/10 text-white/60'  
          }`}  
        >  
          Testnet  
        </button>  
        <button  
          onClick={() => switchNetwork('mainnet')}  
          className={`px-4 py-2 rounded-xl font-semibold transition-all ${  
            network === 'mainnet'   
              ? 'bg-red-500 text-white animate-pulse'   
              : 'bg-white/10 text-white/60'  
          }`}  
        >  
          ‚ö†Ô∏è Mainnet  
        </button>  
      </div>  

      {xrpPrice && (  
        <div className="bg-white/10 backdrop-blur-sm px-4 py-2 rounded-xl">  
          <span className="text-white/70 text-sm">XRP: </span>  
          <span className="text-white font-bold">${xrpPrice.toFixed(4)}</span>  
        </div>  
      )}  
    </div>  

    <div className="bg-gradient-to-br from-white/20 to-white/5 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-white/30">  
      <div className="text-center mb-8">  
        <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-blue-400 to-purple-600 rounded-2xl mb-4 shadow-lg shadow-purple-500/50">  
          <Wallet className="w-10 h-10 text-white" />  
        </div>  
        <h1 className="text-5xl font-bold bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent mb-2">  
          XRP Wallet  
        </h1>  
        <p className="text-white/70 text-sm">Secure ‚Ä¢ Fast ‚Ä¢ Decentralized</p>  
      </div>  

      <div className={`bg-gradient-to-r ${  
        network === 'mainnet'   
          ? 'from-red-500/30 to-orange-500/30 border-red-400/50'  
          : 'from-yellow-500/20 to-orange-500/20 border-yellow-400/50'  
      } border rounded-2xl p-4 mb-8 flex items-start backdrop-blur-sm`}>  
        <AlertCircle className="w-5 h-5 text-yellow-300 mr-3 mt-0.5 flex-shrink-0" />  
        <div className="text-sm text-yellow-100">  
          <strong className="font-semibold">  
            {network === 'mainnet' ? 'üî¥ MAINNET - REAL MONEY!' : 'Testnet Mode'}:  
          </strong>   
          {network === 'mainnet'   
            ? ' You are using the real XRP network. All transactions are final and use real XRP!'  
            : ' This wallet uses the XRP Testnet. Do not send real XRP to these addresses.'  
          }  
        </div>  
      </div>  

      {/* --- UPDATED WALLET LOGIC --- */}
      
      {(!wallet || showInitialActions) ? ( 
        <div className="space-y-4">  
          <button  
            onClick={generateNewWallet}  
            disabled={loading}  
            className="w-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 hover:from-blue-600 hover:via-purple-600 hover:to-pink-600 disabled:from-gray-500 disabled:to-gray-600 text-white font-bold py-5 rounded-2xl transition-all duration-300 flex items-center justify-center shadow-lg shadow-purple-500/50 hover:shadow-purple-500/70 hover:scale-105 transform"  
          >  
            {loading ? <RefreshCw className="w-6 h-6 animate-spin mr-2" /> : <Wallet className="w-6 h-6 mr-2" />}  
            <span className="text-lg">{loading ? 'Generating...' : 'Generate New Wallet'}</span>  
          </button>  
            
          <button  
            onClick={importWallet}  
            disabled={loading}  
            className="w-full bg-white/10 hover:bg-white/20 border-2 border-white/30 hover:border-white/50 text-white font-semibold py-5 rounded-2xl transition-all duration-300 hover:scale-105 transform"  
          >  
            <span className="text-lg">Import Existing Wallet</span>  
          </button>  

          {savedWallets.length > 0 && (
            <button
              onClick={() => {
                setShowWalletSelector(true);
                // If a wallet is currently active, we stay on the main screen, otherwise it'll be hidden behind the lock screen
                if (!wallet) setIsLocked(true); 
              }}
              className="w-full bg-blue-500/20 hover:bg-blue-500/30 border-2 border-blue-400/30 text-blue-300 font-semibold py-3 rounded-2xl transition-all duration-300 flex items-center justify-center gap-2"
            >
              <Wallet className="w-5 h-5" />
              Switch ({savedWallets.length}) Saved Wallets
            </button>
          )}
          
          {wallet && ( // Button to hide the initial actions when wallet is active
            <button
              onClick={() => setShowInitialActions(false)}
              className="w-full bg-white/10 hover:bg-white/20 text-white/70 font-semibold py-3 rounded-xl transition-all"
            >
              <ChevronUp className="w-4 h-4 inline mr-1" /> Hide Wallet Creation
            </button>
          )}

          <div className="text-center text-white/60 mt-8 space-y-1">  
            <p className="text-sm">‚ú® Wallets are generated locally on your device</p>  
            <p className="text-sm">üéÅ Fund via {network === 'mainnet' ? 'an exchange' : 'the official faucet'}</p>  
            <p className="text-sm">üîí Your keys never leave your browser</p>  
          </div>  
        </div>  
      ) : (  
        <div className="space-y-6">  
          
          {/* WALLET ACTIONS / MANAGE WALLETS */}
          <div className="flex gap-2 flex-wrap">  
            <button  
                onClick={saveWalletSecurely}  
                className="flex-1 bg-green-500/20 hover:bg-green-500/30 text-green-300 font-semibold py-2 px-4 rounded-xl transition-all border border-green-400/30 flex items-center justify-center gap-2"  
              >  
                <Download className="w-4 h-4" />  
                Save Wallet  
              </button>  
            {savedWallets.length > 0 && (
              <button
                onClick={() => setShowWalletSelector(true)}
                className="flex-1 bg-blue-500/20 hover:bg-blue-500/30 text-blue-300 font-semibold py-2 px-4 rounded-xl transition-all border border-blue-400/30 flex items-center justify-center gap-2"
              >
                <Wallet className="w-4 h-4" />
                Switch ({savedWallets.length})
              </button>
            )}
            <button  
              onClick={lockWallet}  
              className="flex-1 bg-blue-500/20 hover:bg-blue-500/30 text-blue-300 font-semibold py-2 px-4 rounded-xl transition-all border border-blue-400/30 flex items-center justify-center gap-2"  
            >  
              <Lock className="w-4 h-4" />  
              Lock  
            </button> 
             <button
              onClick={() => setShowInitialActions(true)}
              className="flex-1 bg-white/10 hover:bg-white/20 text-white/70 font-semibold py-2 px-4 rounded-xl transition-all border border-white/20 flex items-center justify-center gap-2"
            >
              <ChevronDown className="w-4 h-4" />
              Manage Wallets
            </button>
          </div>  

          <div className="bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-2xl p-5 border border-blue-400/30 backdrop-blur-sm">  
            <label className="text-sm text-blue-200 font-semibold mb-3 block flex items-center">  
              <CheckCircle className="w-4 h-4 mr-2" />  
              Your Address {wallet.name ? `(${wallet.name})` : ''} 
            </label>  
            <div className="flex items-center gap-2">  
              <input  
                type="text"  
                value={wallet.address || 'N/A'}  
                readOnly  
                className="flex-1 bg-black/30 text-white px-4 py-3 rounded-xl border border-white/20 text-sm font-mono break-all focus:outline-none focus:ring-2 focus:ring-blue-400"  
              />  
              <button  
                onClick={() => copyToClipboard(wallet.address, 'address')}  
                disabled={!wallet.address}  
                className="p-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 disabled:from-gray-600 disabled:to-gray-700 rounded-xl transition-all duration-300 flex-shrink-0 shadow-lg hover:scale-110 transform"  
              >  
                <Copy className="w-5 h-5 text-white" />  
              </button>  
            </div>  
            {copied === 'address' && (  
              <span className="text-xs text-green-300 mt-2 block font-semibold animate-pulse">‚úì Copied!</span>  
            )}  
          </div>  

          <div className="bg-gradient-to-br from-red-500/20 to-orange-500/20 rounded-2xl p-5 border border-red-400/30 backdrop-blur-sm">  
            <label className="text-sm text-red-200 font-semibold mb-3 block flex items-center">  
              <AlertCircle className="w-4 h-4 mr-2" />  
              Secret Key (Keep Private!)  
            </label>  
            <div className="flex items-center gap-2">  
              <input  
                type={showSecret ? 'text' : 'password'}  
                value={wallet.secret || 'No secret available'}  
                readOnly  
                className="flex-1 bg-black/30 text-white px-4 py-3 rounded-xl border border-white/20 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-red-400"  
              />  
              <button  
                onClick={() => setShowSecret(!showSecret)}  
                disabled={!wallet.secret}  
                className="p-3 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 disabled:from-gray-700 disabled:to-gray-800 rounded-xl transition-all duration-300 flex-shrink-0 shadow-lg hover:scale-110 transform"  
              >  
                {showSecret ? <EyeOff className="w-5 h-5 text-white" /> : <Eye className="w-5 h-5 text-white" />}  
              </button>  
              <button  
                onClick={() => copyToClipboard(wallet.secret, 'secret')}  
                disabled={!wallet.secret}  
                className="p-3 bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 disabled:from-gray-600 disabled:to-gray-700 rounded-xl transition-all duration-300 flex-shrink-0 shadow-lg hover:scale-110 transform"  
              >  
                <Copy className="w-5 h-5 text-white" />  
              </button>  
            </div>  
            {copied === 'secret' && (  
              <span className="text-xs text-green-300 mt-2 block font-semibold animate-pulse">‚úì Copied!</span>  
            )}  
          </div>  

          <div className="bg-gradient-to-br from-emerald-500/30 via-teal-500/30 to-cyan-500/30 rounded-2xl p-8 border border-emerald-400/50 backdrop-blur-sm shadow-2xl shadow-emerald-500/20">  
            <div className="flex items-center justify-between mb-4">  
              <h2 className="text-2xl font-bold text-white flex items-center">  
                <div className="w-2 h-2 bg-green-400 rounded-full mr-3 animate-pulse"></div>  
                Balance  
              </h2>  
              <div className="flex gap-2">  
                <button onClick={() => setShowHistory(!showHistory)} className="p-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 rounded-xl transition-all duration-300 shadow-lg hover:scale-110 transform">  
                  <History className="w-5 h-5 text-white" />  
                </button>  
                <button onClick={() => { checkBalance(); loadTransactionHistory(); }} disabled={loading} className="p-3 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 disabled:from-gray-500 disabled:to-gray-600 rounded-xl transition-all duration-300 shadow-lg hover:scale-110 transform">  
                  <RefreshCw className={`w-5 h-5 text-white ${loading ? 'animate-spin' : ''}`} />  
                </button>  
              </div>  
            </div>  
            <div className="text-5xl font-black bg-gradient-to-r from-emerald-200 via-teal-200 to-cyan-200 bg-clip-text text-transparent">  
              {balance !== null && !isNaN(balance) ? `${Number(balance).toLocaleString(undefined, { maximumFractionDigits: 6 })} XRP` : 'Loading...'}  
            </div>  
            <div className="text-emerald-200/70 text-sm mt-2">  
              {xrpPrice && balance ? `‚âà ${(balance * xrpPrice).toFixed(2)} USD` : '‚âà $0.00 USD'}  
            </div>  
              
            {balance === 0 && network === 'testnet' && (  
              <div className="mt-6 bg-yellow-500/20 border border-yellow-400/40 rounded-xl p-4">  
                <div className="flex items-start">  
                  <AlertCircle className="w-5 h-5 text-yellow-300 mr-3 mt-0.5 flex-shrink-0" />  
                  <div className="text-sm text-yellow-100">  
                    <p className="font-semibold mb-2">üí∞ Fund Your Wallet</p>  
                    <ol className="list-decimal list-inside space-y-1 text-xs">  
                      <li>Visit: <a href="https://xrpl.org/xrp-testnet-faucet.html" target="_blank" rel="noopener noreferrer" className="underline text-yellow-200 hover:text-yellow-50">xrpl.org/xrp-testnet-faucet.html</a></li>  
                      <li>Paste your address above</li>  
                      <li>Click "Generate test credentials"</li>  
                      <li>Wait 10 seconds, then click refresh ‚Üª</li>  
                    </ol>  
                  </div>  
                </div>  
              </div>  
            )}  
          </div>  

          {showHistory && (  
            <div className="bg-white/5 rounded-2xl p-5 border border-white/10 backdrop-blur-sm">  
              <h3 className="text-xl font-bold text-white mb-4">Recent Transactions ({transactions.length})</h3>  
              {transactions.length > 0 ? (  
                <div className="space-y-2 max-h-60 overflow-y-auto">  
                  {transactions.map((tx, idx) => (  
                    <div key={idx} className="bg-black/20 rounded-xl p-3 border border-white/10 flex justify-between items-center">  
                      <div className="text-sm font-mono text-white/60 break-all flex-1">  
                        {tx.tx.TransactionType} ‚Ä¢ {tx.tx.hash.substring(0, 10)}...  
                      </div>  
                      <div className={`text-sm ml-2 font-bold ${tx.tx.Amount ? 'text-green-400' : 'text-yellow-400'}`}>  
                        {tx.tx.TransactionType === 'Payment' && tx.tx.Amount &&   
                          `${(parseInt(tx.tx.Amount) / 1000000).toFixed(2)} XRP`  
                        }  
                      </div>  
                    </div>  
                  ))}  
                </div>  
              ) : (  
                <p className="text-white/60 text-center py-4">No transactions yet</p>  
              )}  
            </div>  
          )}  

          <div className="bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-2xl p-6 border border-purple-400/30 backdrop-blur-sm">  
            <h2 className="text-2xl font-bold text-white mb-5 flex items-center">  
              <Send className="w-6 h-6 mr-3" />  
              Send XRP  
            </h2>  
              
            <div className="space-y-4">  
              <div>  
                <label className="text-sm text-purple-200 font-semibold mb-2 block">Recipient Address</label>  
                <div className="flex gap-2">  
                  <input  
                    type="text"  
                    value={recipient}  
                    onChange={(e) => setRecipient(e.target.value)}  
                    placeholder="rXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"  
                    className={`flex-1 bg-black/30 text-white px-4 py-3 rounded-xl border ${  
                      isAddressValid === false ? 'border-red-400' :   
                      isAddressValid === true ? 'border-green-400' :   
                      'border-white/20'  
                    } focus:outline-none focus:ring-2 focus:ring-purple-400 placeholder-white/30`}  
                  />  
                  <button  
                    onClick={() => setShowContacts(!showContacts)}  
                    className="p-3 bg-white/10 hover:bg-white/20 rounded-xl transition-all"  
                    title="Contacts"  
                  >  
                    <BookOpen className="w-5 h-5 text-white" />  
                  </button>  
                </div>  
                {isAddressValid === false && (  
                  <p className="text-xs text-red-300 mt-1">Invalid XRP address</p>  
                )}  
                {isAddressValid === true && (  
                  <p className="text-xs text-green-300 mt-1">‚úì Valid address</p>  
                )}  
              </div>  

              {showContacts && (  
                <div className="bg-black/30 rounded-xl p-4 border border-white/20">  
                  <div className="flex justify-between items-center mb-3">  
                    <h4 className="text-white font-semibold">Contacts</h4>  
                    <button  
                      onClick={addContact}  
                      className="text-xs bg-green-500/20 text-green-300 px-3 py-1 rounded-lg hover:bg-green-500/30"  
                    >  
                      + Add  
                    </button>  
                  </div>  
                  {contacts.length > 0 ? (  
                    <div className="space-y-2 max-h-40 overflow-y-auto">  
                      {contacts.map(contact => (  
                        <div key={contact.id} className="flex items-center gap-2">  
                          <button  
                            onClick={() => selectContact(contact)}  
                            className="flex-1 bg-white/5 hover:bg-white/10 rounded-lg p-2 text-left transition-all"  
                          >  
                            <div className="text-white font-semibold text-sm">{contact.name}</div>  
                            <div className="text-white/50 text-xs font-mono truncate">{contact.address}</div>  
                          </button>  
                          <button  
                            onClick={() => removeContact(contact.id)}  
                            className="p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg transition-all"  
                          >  
                            <Trash2 className="w-4 h-4 text-red-300" />  
                          </button>  
                        </div>  
                      ))}  
                    </div>  
                  ) : (  
                    <p className="text-white/50 text-sm text-center py-2">No contacts yet</p>  
                  )}  
                </div>  
              )}  
                
              <div>  
                <label className="text-sm text-purple-200 font-semibold mb-2 block">Amount (XRP)</label>  
                <input  
                  type="number"  
                  value={amount}  
                  onChange={(e) => setAmount(e.target.value)}  
                  placeholder="0.00"  
                  step="0.000001"  
                  min="0"  
                  className="w-full bg-black/30 text-white px-4 py-3 rounded-xl border border-white/20 focus:outline-none focus:ring-2 focus:ring-purple-400 placeholder-white/30"  
                />  
                {amount && xrpPrice && (  
                  <p className="text-xs text-white/50 mt-1">‚âà ${(parseFloat(amount) * xrpPrice).toFixed(2)} USD</p>  
                )}  
              </div>  
                
              <div>  
                <label className="text-sm text-purple-200 font-semibold mb-2 block">  
                  Destination Tag (Optional)  
                </label>  
                <input  
                  type="number"  
                  value={destinationTag}  
                  onChange={(e) => setDestinationTag(e.target.value)}  
                  placeholder="e.g., 12345"  
                  className="w-full bg-black/30 text-white px-4 py-3 rounded-xl border border-white/20 focus:outline-none focus:ring-2 focus:ring-purple-400 placeholder-white/30"  
                />  
              </div>  
                
              <button  
                onClick={handleSendClick}  
                disabled={!wallet || !recipient || !amount || loading}  
                className="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 disabled:from-gray-500 disabled:to-gray-600 text-white font-bold py-4 rounded-xl transition-all duration-300 shadow-lg hover:scale-105 transform flex items-center justify-center"  
              >  
                <Send className="w-5 h-5 mr-2" />  
                Send XRP  
              </button>  
            </div>  
          </div>  
        </div>  
      )}  
    </div>  
  </div>  

  <TransactionModal  
    show={showModal}  
    onClose={handleCloseModal}  
    onConfirm={handleConfirmTransaction}  
    recipient={recipient}  
    amount={amount}  
    destinationTag={destinationTag}  
    loading={txLoading}  
    error={txError}  
    success={txSuccess}  
  />  

  <QRCodeModal  
    show={showQRModal}  
    onClose={() => setShowQRModal(false)}  
    address={wallet?.address}  
  />  

  <WalletSelectorModal 
    show={showWalletSelector} 
    onClose={() => setShowWalletSelector(false)} 
    wallets={savedWallets} 
    onSwitch={switchToWallet} 
    onDelete={deleteWalletFromList} 
  />
</div>

);
};

export default App;

